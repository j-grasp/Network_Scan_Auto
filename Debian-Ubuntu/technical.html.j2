<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Technical Vulnerability Report — {{ scan_date }}</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: "Consolas", "Courier New", monospace;
         background: #0d1117; color: #c9d1d9; padding: 24px; }
  .page { max-width: 1300px; margin: 0 auto; }
  h1 { color: #58a6ff; font-size: 1.5em; margin-bottom: 4px; }
  .meta { color: #8b949e; font-size: 0.83em; margin-bottom: 24px; }
  .sumbar { display: flex; gap: 20px; flex-wrap: wrap;
            background: #161b22; border-radius: 8px; padding: 18px 24px;
            margin-bottom: 28px; border: 1px solid #30363d; }
  .sumbar-item { text-align: center; min-width: 80px; }
  .sumbar-item .n { font-size: 2em; font-weight: 700; }
  .sumbar-item .l { font-size: 0.75em; color: #8b949e; margin-top: 2px; }
  .c-CRITICAL { color: #f85149; } .c-HIGH { color: #d29922; }
  .c-MEDIUM   { color: #d29922; } .c-LOW  { color: #3fb950; }
  .c-INFO     { color: #58a6ff; } .c-def  { color: #c9d1d9; }
  .segment { margin-bottom: 32px; border: 1px solid #30363d;
             border-radius: 10px; overflow: hidden; }
  .seg-header { background: #161b22; padding: 14px 20px;
                display: flex; align-items: center; gap: 12px; }
  .seg-header h2 { color: #58a6ff; font-size: 1em; }
  .seg-header .seg-meta { color: #8b949e; font-size: 0.8em; }
  .host { border-top: 1px solid #21262d; padding: 16px 20px; }
  .host-header { display: flex; gap: 14px; align-items: baseline;
                 margin-bottom: 10px; flex-wrap: wrap; }
  .host-ip   { color: #79c0ff; font-size: 1.05em; font-weight: 700; }
  .host-name { color: #8b949e; font-size: 0.85em; }
  .host-os   { color: #8b949e; font-size: 0.82em; font-style: italic; }
  table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
  thead tr { background: #21262d; }
  th { padding: 8px 12px; text-align: left; color: #8b949e;
       font-weight: 600; border-bottom: 1px solid #30363d; }
  td { padding: 7px 12px; border-bottom: 1px solid #161b22; vertical-align: top; }
  tr:last-child td { border-bottom: none; }
  .port-num { color: #79c0ff; font-weight: 700; }
  .svc-name { color: #e3b341; }
  .banner   { color: #8b949e; font-size: 0.9em; }
  .no-cve   { color: #484f58; font-style: italic; }
  .badge { display: inline-block; padding: 1px 8px; border-radius: 12px;
           font-size: 0.75em; font-weight: 700; color: #fff; margin-right: 4px; }
  .badge-CRITICAL { background: #b91c1c; }
  .badge-HIGH     { background: #b45309; }
  .badge-MEDIUM   { background: #92400e; }
  .badge-LOW      { background: #166534; }
  .badge-INFO     { background: #1e3a5f; }
  details { margin-top: 6px; }
  details summary { cursor: pointer; color: #8b949e; font-size: 0.82em; list-style: none; }
  details summary::before { content: "&#9658; "; }
  details[open] summary::before { content: "&#9660; "; }
  pre { white-space: pre-wrap; word-break: break-all; background: #0d1117;
        border: 1px solid #30363d; border-radius: 6px; padding: 10px;
        font-size: 0.78em; color: #d2a679; margin-top: 8px;
        max-height: 300px; overflow-y: auto; }
  .cve-line { margin-bottom: 3px; font-size: 0.82em; }
  .no-open  { color: #484f58; font-style: italic; padding: 10px 0; }
  .err-badge { background: #5a1d1d; color: #f85149; padding: 4px 10px;
               border-radius: 6px; font-size: 0.82em; }
</style>
</head>
<body>
<div class="page">

<h1>Vulnerability Scan — Technical Report</h1>
<p class="meta">Date: {{ scan_date }}
  &nbsp;·&nbsp; Classification: INTERNAL — SECURITY TEAM ONLY
  &nbsp;·&nbsp; No exploit code was executed</p>

<div class="sumbar">
  <div class="sumbar-item">
    <div class="n c-def">{{ summary.total_hosts }}</div>
    <div class="l">Hosts</div>
  </div>
  <div class="sumbar-item">
    <div class="n c-def">{{ summary.open_ports }}</div>
    <div class="l">Open Ports</div>
  </div>
  <div class="sumbar-item">
    <div class="n c-def">{{ summary.hosts_with_findings }}</div>
    <div class="l">With Findings</div>
  </div>
  {% for sev in severity_order %}
  <div class="sumbar-item">
    <div class="n c-{{ sev }}">{{ summary.severity_counts[sev] }}</div>
    <div class="l">{{ sev }}</div>
  </div>
  {% endfor %}
</div>

{% for seg in segments %}
{% set seg_hosts = seg.hosts | default([]) %}
<div class="segment">
  <div class="seg-header">
    <h2>{{ seg.label }}</h2>
    <span class="seg-meta">{{ seg_hosts | length }} host(s)</span>
    {% if seg.error %}
      <span class="err-badge">&#9888; Scan error: {{ seg.error }}</span>
    {% endif %}
  </div>

  {% if seg_hosts %}
    {% for host in seg_hosts %}
    <div class="host">
      <div class="host-header">
        <span class="host-ip">{{ host.ip }}</span>
        {% if host.hostname %}<span class="host-name">{{ host.hostname }}</span>{% endif %}
        {% if host.os and host.os != "False" %}<span class="host-os">OS: {{ host.os }}</span>{% endif %}
      </div>

      {% set open_svcs = host.services | selectattr("state","equalto","open") | list %}
      {% if open_svcs %}
      <table>
        <thead>
          <tr>
            <th style="width:70px;">Port</th>
            <th style="width:60px;">Proto</th>
            <th style="width:120px;">Service</th>
            <th style="width:220px;">Banner / Version</th>
            <th>Vulnerability Findings</th>
          </tr>
        </thead>
        <tbody>
        {% for svc in open_svcs %}
        {% set cves = extract_cves(svc.scripts) %}
        <tr>
          <td class="port-num">{{ svc.port }}</td>
          <td>{{ svc.protocol }}</td>
          <td class="svc-name">{{ svc.service }}</td>
          <td class="banner">{{ svc.product | default("") }}</td>
          <td>
            {% if cves %}
              {% for cve in cves %}
              <div class="cve-line">
                <span class="badge badge-{{ cve.severity }}">{{ cve.severity }}</span>
                <strong>{{ cve.cve_id }}</strong>
                <span style="color:#8b949e;">— {{ cve.detail[:120] }}</span>
              </div>
              {% endfor %}
            {% else %}
              <span class="no-cve">No CVEs matched in offline database</span>
            {% endif %}
            {% if svc.scripts %}
            <details>
              <summary>Raw NSE output ({{ svc.scripts | length }} script(s))</summary>
              <pre>{% for k,v in svc.scripts.items() %}[{{ k }}]
{{ v }}

{% endfor %}</pre>
            </details>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
        </tbody>
      </table>
      {% else %}
        <p class="no-open">No open ports detected on this host.</p>
      {% endif %}
    </div>
    {% endfor %}
  {% else %}
    <div class="host"><p class="no-open">No hosts returned results for this segment.</p></div>
  {% endif %}
</div>
{% endfor %}

</div>
</body>
</html>
